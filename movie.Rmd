---
title: "movie"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
x = 1
```

```{r}
library(magrittr)
library(plyr)
```
# Variables
```{r}
ratings = read.csv('ratings.csv')
movies = read.csv('movies.csv')
links = read.csv('links.csv')
tags = read.csv('tags.csv')
genome_scores = read.csv('genome-scores.csv')
genome_tags = read.csv('genome-tags.csv')
```

```{r}
class(ratings)
```

## Top film

```{r}

#View(movies)
#View(ratings)

#ratings <- as.data.frame(ratings)

#View(ratings$timestamp)

#View(as.POSIXct(ratings$timestamp, origin="1970-01-01"))

#ratings$timestamp = as.POSIXct(ratings$timestamp, origin="1970-01-01")

#?substr

#ratings$timestamp = as.integer(substr(ratings$timestamp, 1, 4))

#ratings = as.data.frame(ratings)

#View(ratings)

```


```{r}

#Meilleure ratings
# nbview = aggregate(ratings, list(Movie=ratings.movieId), sum)
(movie_views = count(ratings, vars = "movieId"))

```
```{r}
#top_view = head(movie_views[order(movie_views$freq, decreasing = TRUE),], 100)
top_view = merge(x = movies, y = movie_views, by.x = "movieId", by.y = "movieId")

top_view_1 = as.data.frame(top_view)

```

```{r}
View(top_view_1)
```

```{r}
?sort

top_view_1 = top_view_1[order(top_view_1$freq, decreasing = TRUE),]

View(top_view_1)
```

```{r}
#View(top_view_1)

length(top_view_1[top_view_1$freq > 1000,]$freq)/length(top_view_1$freq)

hist(top_view_1[top_view_1$freq > 1000,]$freq)
```
```{r}
#boxplot(top_view_1[top_view_1$freq > 1000,]$freq)

top_view_1 = top_view_1[top_view_1$freq > 1000,]
View(top_view_1)
```


```{r}
top_view_2 = merge(x = top_view_1, y = ratings, by.x = "movieId", by.y = "movieId")

View(top_view_2)
```

##DROP BELOW THE 1Q

```{r}
boxplot(top_view_2$rating[top_view_2$movieId == 1], col="blue",outline = FALSE)
```
```{r}

summary(top_view_2$rating[top_view_2$movieId == 1])

#summary(top_view_2$rating[top_view_2$movieId == 1])[2]
```
```{r}
#top_view_2["summary"]=0
#View(top_view_2)
```


```{r}
summary(top_view_2$rating)
```
```{r}
library(data.table)
```
```{r}
top_view_2 = as.data.table(top_view_2)
```

```{r}
#View(top_view_2[, list('1Q' = summary(rating)[2]), by=list(movieId)])
```

```{r}
top_view_agg = top_view_2[, list('1Q' = summary(rating)[2]), by=list(movieId)]
```

```{r}
top_view_3 = merge(x = top_view_2, y = top_view_agg, by.x = "movieId", by.y = "movieId")
```

```{r}
#View(top_view_3)
```

```{r}
top_view_4 = top_view_3[rating >= '1Q']
```

##1. Distribution des avis pour les 10 films les plus notés

```{r}
#1. Analyse de variables une par une 

## outliers 

##Liste de films 
##
## distribution des avis par film 
##boxplot 

##boxplot des 5 premiers films les plus vus

ten_most_ranked_movies = top_view_1$title[1:10]

ten_most_ranked_movies[1:10]
```

```{r}
d <- data.frame(word = sub("\\(.*", "", top_view_1$title[1:10]),freq=top_view_1$freq[1:10])

d
```

```{r}
library(forcats)
library(ggplot2)
```

```{r}
# Barplot basique

d %>%
mutate(word = fct_reorder(word, freq)) %>%
ggplot(aes(x=word, y=freq)) +
  geom_bar(stat="identity") + coord_flip()

```

```{r}
library(wordcloud)
```

```{r}
d <- data.frame(word = sub("\\(.*", "", top_view_1$title[1:100]),freq=top_view_1$freq[1:100])
d
```
```{r}
wordcloud(words = d$word, freq = d$freq, 
               max.words=100, random.order=FALSE, 
               colors=brewer.pal(8, "Dark2"), scale=c(.5,.5))
```


```{r}
for(i in seq(1, 1)) {
  boxplot(top_view_4$rating[top_view_4$title == five_most_ranked_movies[i]], col="blue",outline = FALSE)
}


for(i in seq(1, 5)) {
  hist(top_view_4$rating[top_view_4$title == five_most_ranked_movies[i]], col="blue")
}

#boxplot(top_view_4$rating[top_view_4$title == five_most_ranked_movies[1]], col="blue",outline = FALSE)

```

##2. Nombre d'avis par année


```{r}
#rm(list=c('top_view_2', 'top_view_3'))
```

```{r}

top_view_4$timestamp <-  as.POSIXct(top_view_4$timestamp, origin="1970-01-01")

```

```{r}
#class(top_view_4)
#View(format(top_view_4$timestamp, "%Y"))

#format(top_view_4$timestamp[1:4], "%Y")

top_view_4$year=format(top_view_4$timestamp, "%Y")
```

```{r}
View(top_view_4[1])
```

```{r}
ranking_per_year = top_view_4[, list(Ranking_Total_Per_Year = .N), 
                              by=list(year)][order(-year)]

View(ranking_per_year)
```

```{r}
library(ggplot2)
```


```{r}
# Barplot basique

ranking_per_year %>%
  mutate(year = fct_reorder(year, desc(year))) %>%
ggplot(aes(x=year, y=Ranking_Total_Per_Year)) +
  geom_bar(stat="identity") + coord_flip()
```

##3. Nombre d'avis par année (par différence avec la sortie du film)

```{r}
library(stringr)
```

```{r}
#str_split(movies$title[1], pattern='(')
top_view_4$release_year = str_extract(top_view_4$title, '(?<=\\()[0-9-]+(?=\\))')
```

```{r}

top_view_release = top_view_4[, list(Diff_Release_Year = .N), 
                              by=list(as.numeric(format(timestamp, "%Y")) - as.numeric(str_extract(title, '(?<=\\()[0-9-]+(?=\\))')))]

```

```{r}
top_view_release = top_view_release[order(as.numeric)][5:104]
```

```{r}
View(top_view_release)
```

```{r}
# Barplot basique
p = ggplot(data=top_view_release, aes(x=as.numeric, y=Diff_Release_Year)) +
  geom_bar(stat="identity")
p
```
##5 Repartition par userID: quel user a le plus noté ? 

```{r}
top_users = top_view_4[, list(Ranking_User = .N), 
                              by=list(userId)][order(-Ranking_User)]
```

```{r}
View(top_users[1:100])
```

```{r}
top_users[1:100] %>%
  mutate(userId = fct_reorder(factor(userId), desc(Ranking_User))) %>%
  ggplot(aes(x=userId, y=Ranking_User)) +
  geom_bar(stat="identity")
  
#barplot(top_users[1:100]$Ranking_User ~ top_users[1:100]$userId)
```
##4. Tags les plus populaires sur la dataset 

```{r}
View(genome_tags)
```

```{r}
genome_scores = as.data.table(genome_scores)
```

```{r}
View(genome_scores)
```

```{r}
tags = merge(x = genome_tags, y = genome_scores, by.x = "tagId", by.y = "tagId", all.x = FALSE, all.y = FALSE)
```

```{r}
View(tags)
```

```{r}
tags = as.data.table(tags)
```

```{r}
tags_counter = tags[, list(Count_by_tag = .N), 
                              by=tagId]
```

```{r}
View(tags_counter)
```

```{r}
library(wordcloud)
```

```{r}
d <- data.frame(word = tags_counter$tag,freq=tags_counter$Count_by_tag)

head(d, 30)

```

```{r}
View(tags_counter)
```

```{r}
wordcloud(words = d$word, freq = d$freq, min.freq = 13815, max.words=200, random.order=FALSE, colors=brewer.pal(8, "Dark2"))
```

##5. Tags les plus populaires par annee 

```{r}
#To be continued...
```

##6. Genre des films de la base par ordre décroissant

```{r}
#To be continued...

#View(top_view_4)

#View(top_view_4[, list(Count=.N), by=list(title, genres)])

#top_view_4$genres[1]

#(str_extract_all(top_view_4$genres[1], "Animation"))


#grepl('Animation', top_view_4$genres[1], fixed = TRUE)

temp = top_view_4[, list(Count=.N), by=list(genres)]$genres
View(temp)

class(temp)

temp2 = lapply(temp, function(x) str_split(x, pattern='\\|'))

all_genres = unique(unlist(temp2))

#all_genres

all_movies = top_view_4[, list(Count=.N), by=list(title, genres)]

#View(all_movies)

counter_movies = data.frame(Genre="1",
                 Nombre=1)
#View(counter_movies)

for (i in seq(all_genres)) {
  #print(all_genres[i])
  #print(paste(all_genres[i], ':', count(grepl(all_genres[i], all_movies$genres, fixed = TRUE))[2, 2]))
  
  #print(all_genres[i])
  df_aux = c(all_genres[i], count(grepl(all_genres[i], all_movies$genres, fixed = TRUE))[2, 2])
  counter_movies = rbind(counter_movies, df_aux)
}

#View(counter_movies)

counter_movies = counter_movies[-1,]



counter_movies$Nombre = as.numeric(counter_movies$Nombre)

counter_movies %>%
  mutate(Genre = fct_reorder(Genre, Nombre)) %>%
  ggplot(aes(x=Genre, y=Nombre)) +
  geom_bar(stat="identity") + coord_flip()

```

```{r}
View(counter_movies)

wordcloud(words = counter_movies$Genre, freq = counter_movies$Nombre, 
               max.words=10, random.order=FALSE, 
               colors=brewer.pal(8, "Dark2"), scale=c(3,3))

```
##7. Genre des films de la base les plus courants par année et par ordre décroissant

```{r}
#To be continued...

#View(top_view_4)

#View(top_view_4[, list(Count=.N), by=list(title, genres)])

#top_view_4$genres[1]

#(str_extract_all(top_view_4$genres[1], "Animation"))


#grepl('Animation', top_view_4$genres[1], fixed = TRUE)
#temp = top_view_4[, list(Count=.N), by=list(genres)]$genres
#View(temp)
#class(temp)
#temp2 = lapply(temp, function(x) str_split(x, pattern='\\|'))
#all_genres = unique(unlist(temp2))
#all_genres

all_movies = top_view_4[, list(Count=.N), by=list(title, genres, release_year)]

#View(all_movies)

#View(all_movies[, list(.N), by=release_year][order(release_year)])

counter_movies = data.frame(Genre="",
                 Nombre=1, Year=1)
#View(counter_movies)

dim(all_movies)[1]

length(all_genres)

df = data.frame(matrix(0L, ncol = length(all_genres), nrow = length(seq(1920, 2020))))

names(df) = all_genres

#View(df)

#seq(1920,2020)

rownames(df) = seq(1920,2020)

View(df)

df[1920, 'Adventure']

for (i in seq(all_genres)) {
  
  for(j in seq(dim(all_movies)[1])) {
    
    if(grepl(all_genres[i], all_movies[j]$genres, fixed = TRUE) & !is.na(all_movies[j]$release_year) & all_movies[j]$release_year != 500){
      
      df[all_movies[j]$release_year, all_genres[i]] = df[all_movies[j]$release_year, all_genres[i]] + 1 
    }
  }
}

##df -  Genre des films de la base les plus courants par année et par ordre décroissant

View(df)
```

```{r}

#View(movies)

df_year = data.frame(matrix(0L, ncol = length(seq(1,2)), nrow = length(seq(1920, 2019))))

names(df_year) = c("genre_le_plus_courant_par_annee", "combien")

View(df_year)

dim(df)[2]

View(df)

colnames(df)

rownames(df_year) =seq(1920,2019)

#df_year['1920', 'genre_le_plus_courant_par_annee']


for (i in rownames(df_year)) {
  
  max = 0
  genre = NA 

  for(j in colnames(df)) {
    
    if(df[i,j] > max) {
      max = df[i,j]
      genre = j 
      
    }
  }
  
  df_year[i, 'genre_le_plus_courant_par_annee'] = genre
   df_year[i, 'combien'] = max
  
}

View(df_year)

df_plot = df_year[1:30,]

ggplot(df_plot, aes(x= rownames(df_plot), y= combien, colour=genre_le_plus_courant_par_annee, label=genre_le_plus_courant_par_annee))+
  geom_point() +geom_text(aes(label=genre_le_plus_courant_par_annee),hjust=0, vjust=0)

```






```{r}



avg_ratings = ddply(ratings, .(movieId), summarize, Avg=mean(rating))
top_populaire = head(avg_ratings[order(avg_ratings$Avg, decreasing = TRUE),], 100)
movie_top = merge(x = movies, y = top_populaire, by.x = "movieId", by.y = "movieId")
View(movie_top)

#Merge
#all_data c'est toutes les données pour les films
all_data = merge(x =ratings, y = movies, by.x = "movieId", by.y = "movieId")
all_data = merge(x = all_data, y = links, by.x = "movieId", by.y = "movieId")
all_data = merge(x = all_data, y = tags, by.x = "movieId", by.y = "movieId")
all_data = merge(x = all_data, y = genome_scores, by.x = "movieId", by.y = "movieId")




```











## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
